
{% extends "base.html" %}
{% block title %}Recommendation{% endblock%}
{% block content %}
<style>.hytPlayerWrap{display:inline-block;position:relative}.hytPlayerWrap.ended::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;cursor:pointer;background-color:black;background-repeat:no-repeat;background-position:center;background-size:64px 60px;background-image:url(data:image/svg+xml;utf8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiB2aWV3Qm94PSIwIDAgNTEwIDUxMCI+PHBhdGggZD0iTTI1NSAxMDJWMEwxMjcuNSAxMjcuNSAyNTUgMjU1VjE1M2M4NC4xNSAwIDE1MyA2OC44NSAxNTMgMTUzcy02OC44NSAxNTMtMTUzIDE1My0xNTMtNjguODUtMTUzLTE1M0g1MWMwIDExMi4yIDkxLjggMjA0IDIwNCAyMDRzMjA0LTkxLjggMjA0LTIwNC05MS44LTIwNC0yMDQtMjA0eiIgZmlsbD0iI0ZGRiIvPjwvc3ZnPg==)}.hytPlayerWrap.paused::after{content:"";position:absolute;top:0px;left:30px;bottom:0px;right:30px;cursor:pointer;background-color:black;background-repeat:no-repeat;background-position:center;background-size:40px 40px;background-image:url(data:image/svg+xml;utf8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEiIHdpZHRoPSIxNzA2LjY2NyIgaGVpZ2h0PSIxNzA2LjY2NyIgdmlld0JveD0iMCAwIDEyODAgMTI4MCI+PHBhdGggZD0iTTE1Ny42MzUgMi45ODRMMTI2MC45NzkgNjQwIDE1Ny42MzUgMTI3Ny4wMTZ6IiBmaWxsPSIjZmZmIi8+PC9zdmc+)}</style>
<h3 id="title" style="text-align:center">为您推荐：(<span>{{cur_count}}</span>/<span>{{cur_total}}</span>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </h3>
<div class="wholeSec">
<div style="text-align: center">
<form method="post" class="forms" id="nextForm">
<input hidden id="pct_watched" name="next"></input>
<input hidden id ="nextSec" name = "mysrc"></input>
<div class="videoWrapper">
<div class="hytPlayerWrapOuter">
    <div class = "btns">
        <button type="button" onclick="prev()" id="prevBtn" class="btn btn-primary btn-lg" style="font-size: 16px; padding-right: 14px; padding-left: 15px;">← 前一个</button>
        <button hidden type="submit" onclick="calPct()" id="prevButton">← Prev</button>
    </div>
    <div class="hytPlayerWrap" id="hytPlayerWrapID">
        <!--<div class="myPlayer" id="player" align="center"></div>-->
        <!--修改-->
        <!--<video id="player" width="900" height="600" controls>-->
        <!--    <source src="https://vidrepver2.pythonanywhere.com/static/DouyinVideos/6616990050930396423.mp4" type="video/mp4">-->
        <!--    Your browser does not support the video tag.-->
        <!--</video>-->
    </div>
    <div class = "btns">
        <button type="button" onclick="pop()" id="popUp" disabled="disabled" class="btn btn-primary btn-lg" style="font-size: 16px">下一个 →</button>
        <button hidden type="submit" onclick="calPct()" id="nextButton" disabled="disabled">Next --></button>
    </div>
</div>
 <div class="loading style-2" id="loader" hidden>
 <div class="ratePopup">
      <div class="form-popup" id="popupForm">
        <form id="ratingForm" class="form-container" name="rateForm">
          <p2>请选择您对该视频的喜爱程度</p2>
            <hr>
            <div class="radio-container">
                <div><span> </span></div>
                <div class="group1">
                    <input class="form-check-input" type="radio" name="opt" id="opt1" value="1">
                    <label class="form-check-label" for="opt1">1 (extremely uninterested) </label>
                </div>
                <div class="group2">
                    <input class="form-check-input" type="radio" name="opt" id="opt2" value="2">
                    <label class="form-check-label" for="opt2">2 (not interested)</label>
                </div>
                <div class="group3">
                    <input class="form-check-input" type="radio" name="opt" id="opt3" value="3">
                    <label class="form-check-label" for="opt3">3 (neutral)</label>
                </div>
                <div class="group4">
                    <input class="form-check-input" type="radio" name="opt" id="opt4" value="4">
                    <label class="form-check-label" for="opt4">4 (somewhat interested) </label>
                </div>
                <div class="group5">
                    <input class="form-check-input" type="radio" name="opt" id="opt5" value="5">
                    <label class="form-check-label" for="opt5">5 (very interested)</label>
                </div>
            </div>
          <hr>
          <button type="button" class="btn btn-light btn-outline-primary" onclick="sendRating()" id="submitRating">提交</button>
        </form>
        <div class="loading style-2" id="loader2" hidden><div class="loading-wheel"></div>
        <script>
            function sendRating() {
                const button = document.getElementById("submitRating");
                button.disabled = true;
                document.getElementById("loader2").removeAttribute("hidden");
                var ratings = document.getElementsByName("opt");
                var rating = 0;
                for (var i = 0, length = ratings.length; i < length; i++) {
                  if (ratings[i].checked) {
                    rating = ratings[i].value;
                    break;
                  }
                }
                if (rating == 0) {
                    alert("Please select a value!");
                    document.getElementById("loader2").hidden = true;
                    document.getElementById("submitRating").disabled = false;
                 }
                 else {
                    var pay_load;
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", '/rating');
                    xhr.setRequestHeader("Content-Type", "application/json");
                    pay_load = {"rating": rating, "id": '{{video_id}}'};
                    xhr.send(JSON.stringify(pay_load));
                    xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4) {
                        console.log(xhr.status);
                        console.log(xhr.responseText);
                        document.getElementById('nextButton').click();
                      }};
                 }
            }
        </script>
      </div>
    </div>
 </div>
 </div>
</div>
</form>
</div>
</div>
<div class = "commentSec" id = "com_con">
<div class="optionbar">
  <span title="thumdsup">
      <button id = "like_btn" class="fabutton" onclick="sendLike()" type="submit">
        <i class="fa-solid fa-thumbs-up" style='font-size:34px'></i>
      </button>
          &nbsp;&nbsp;<span id = "num_like">0</span>&nbsp;&nbsp;
    </span>
  <span title="thumdsdown" class="dislike">
      <button id = "dislike_btn" class="fabutton" onclick="sendDis()" type="submit" >
        <i class="fa-solid fa-thumbs-down" style='font-size:34px'></i>
      </button>
      &nbsp;&nbsp;<span id = "num_dislike">0</span>&nbsp;&nbsp;
    </span>
  <!--<span title="star" class="star">-->
  <!--  <button id = "star_btn" class="fabutton" onclick="sendStar()" type="submit">-->
  <!--      <i class="fa-solid fa-star" style='font-size:34px'></i>-->
  <!--  </button>-->
  <!--    &nbsp;&nbsp;<span id = "num_saved">0</span>&nbsp;&nbsp;-->
  <!--  </span>-->
</div>
<br>
<div class="comBox">
<!--<h4>Comments(<span id="num_comments">0</span>):</h4>-->
<h4>评论（<span id="num_comments">0</span>）:</h4>
    <div class="textarea-container" >
    <i class="ipt-arrow"></i>
    <!--<textarea cols="80" id= "comment" name="comment" rows="5" placeholder="Please enter your comments" class="comments"></textarea>-->
    <textarea cols="80" id= "comment" name="comment" rows="5" placeholder="说点什么…" class="comments"></textarea>
    </div>
    <!--<button type="submit" class="btn btn-light btn-outline-primary" onclick="sendCom()"><span class="submit-text">Submit</span></button>-->
    <button type="submit" class="btn btn-light btn-outline-primary" onclick="sendCom()"><span class="submit-text">发送</span></button>
    <br>
<ul class="list-group list-group-flush" id="notes">
  {% for u,c in zip(users, coms) %}
  <li class="list-group-item">
    <span class = "com_username">{{u}}:</span>
    <span class = "com_com">{{ c }}</span>
  </li>
  {% endfor %}
</ul>
</div>
</div>
<br>
</div>
<script>
    var v_id = '{{video_id}}';
    document.getElementById("nextSec").value = v_id;
    document.getElementById("num_comments").innerHTML = {{len_com}};
    document.getElementById("num_like").innerHTML = {{len_like}};
    document.getElementById("num_dislike").innerHTML = {{len_dislike}};
    document.getElementById("num_saved").innerHTML = {{len_saved}};
</script>
<script>
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    var player;
    var timer;

    // 动态加载视频的函数
    function loadVideoById() {
        var videoId = '{{video_id}}';
        const playerWrap = document.getElementById('hytPlayerWrapID');
        playerWrap.innerHTML = ''; // 清空现有内容

        // 创建 <video> 元素
        const videoElement = document.createElement('video');
        videoElement.id = 'player';
        videoElement.width = 900;
        videoElement.height = 600;
        videoElement.controls = true;
        videoElement.autoplay = true;

        // 动态设置视频源
        const sourceElement = document.createElement('source');
        sourceElement.src = `/static/DouyinVideos/${videoId}.mp4`;  // 根据 videoId 动态设置视频路径
        sourceElement.type = 'video/mp4';

        videoElement.appendChild(sourceElement);
        playerWrap.appendChild(videoElement);

        // 绑定 onReady 事件，当 iframe 加载完成时触发
        videoElement.addEventListener('loadeddata', function () {
            console.log('Video is ready');
            onPlayerReady();  // 模拟 onReady
        });

        // 绑定视频的事件
        videoElement.addEventListener('loadeddata', onPlayerReady);
        videoElement.addEventListener('play', function() {
            console.log('Video is playing');
            onPlayerStateChange({ data: 1 }); // 模拟播放状态变化
        });
        videoElement.addEventListener('pause', function() {
            console.log('Video is paused');
            onPlayerStateChange({ data: 2 }); // 模拟暂停状态变化
        });
        videoElement.addEventListener('ended', function() {
            console.log('Video has ended');
            onPlayerStateChange({ data: 'Ended' }); // 模拟结束状态变化
        });
    }

    // 当视频准备好时触发
    function onPlayerReady() {
        const videoElement = document.getElementById('player');
        videoElement.removeAttribute('allowfullscreen');  // 移除全屏
        videoElement.setAttribute('donotallowfullscreen', '');  // 设置自定义属性

        document.getElementById('nextButton').removeAttribute('disabled');
        document.getElementById('popUp').removeAttribute('disabled');

        // 发送视频已准备好的状态的请求
        var pay_load;
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/ready');
        xhr.setRequestHeader("Content-Type", "application/json");
        pay_load = { "id": videoElement.getAttribute('data-video-id'), "status": "ready" }; // 发送当前视频的 ID
        xhr.send(JSON.stringify(pay_load));
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                console.log(xhr.status);
                console.log(xhr.responseText);
            }
        };
    }

    // // 通过指定的 video_id 动态加载视频
    // const videoId = 'sample_video';  // 这里可以动态设置视频ID
    loadVideoById();  // 调用函数加载视频


    // function onYouTubeIframeAPIReady() {
    //     player = new YT.Player('player', {
    //         height: '600',
    //         width: '900',
    //         videoId: '{{video_id}}',
    //         playerVars: {
    //             'autoplay': 1,
    //             fs: 0
    //             },
    //         events: {
    //             'onReady': onPlayerReady,
    //             'onStateChange': onPlayerStateChange
    //         }
    //     });
    // }

    // function onPlayerReady(){
    //     const iframe = player.getIframe();
    //     iframe.removeAttribute('allowfullscreen');
    //     iframe.setAttribute('donotallowfullscreen', '');
    //     document.getElementById('nextButton').removeAttribute('disabled');
    //     document.getElementById('popUp').removeAttribute('disabled');
    //     var pay_load;
    //     var xhr = new XMLHttpRequest();
    //     xhr.open("POST", '/ready');
    //     xhr.setRequestHeader("Content-Type", "application/json");
    //     pay_load = {"id": '{{video_id}}', "status" : "ready"};
    //     xhr.send(JSON.stringify(pay_load));
    //     xhr.onreadystatechange = function () {
    //     if (xhr.readyState == 4) {
    //         console.log(xhr.status);
    //         console.log(xhr.responseText);
    //       }
    //       };

    // }

    let playerWrap = document.getElementById('hytPlayerWrapID');

    function onPlayerStateChange(newState) {
        // 下一行为修改
        const videoElement = document.getElementById('player');

        if (newState.data == 1) {
            // timer = setInterval(record,500);
            // 下面两行被注销
            // playerWrap.classList.remove("ended");
            // playerWrap.classList.remove("paused");
            // var pct = player.getCurrentTime()/player.getDuration();
            // 上一行修改为下一行
            var pct = videoElement.currentTime / videoElement.duration;
            var pay_load;
            var xhr = new XMLHttpRequest();
            xhr.open("POST", '/track');
            xhr.setRequestHeader("Content-Type", "application/json");
            pay_load = {"pct": pct, "id": '{{video_id}}', "status" : "playing", "time": Date.now()};
            xhr.send(JSON.stringify(pay_load));
            xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                console.log(xhr.status);
                console.log(xhr.responseText);
              }};
        }
        else if (newState.data == 2) {
            // 下面一行被注销
            // playerWrap.classList.add("paused");
            //clearInterval(timer);
            // var pct = player.getCurrentTime()/player.getDuration();
            // 上一行修改为下一行
            var pct = videoElement.currentTime / videoElement.duration;
            var pay_load;
            var xhr = new XMLHttpRequest();
            xhr.open("POST", '/track');
            xhr.setRequestHeader("Content-Type", "application/json");
            pay_load = {"pct": pct, "id": '{{video_id}}', "status" : "paused", "time": Date.now()};
            xhr.send(JSON.stringify(pay_load));
            xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                console.log(xhr.status);
                console.log(xhr.responseText);
              }};
        }
        else if (newState.data == 'Ended'){
        // else if (newState.data == YT.PlayerState.ENDED){
            // 下面一行被注销
            // playerWrap.classList.add("ended");
            //clearInterval(timer);
            var pay_load;
            var xhr = new XMLHttpRequest();
            xhr.open("POST", '/track');
            xhr.setRequestHeader("Content-Type", "application/json");
            pay_load = {"pct": 1, "id": '{{video_id}}', "status" : "completed", "time": Date.now()};
            xhr.send(JSON.stringify(pay_load));
            xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                console.log(xhr.status);
                console.log(xhr.responseText);
              }
              };
            document.getElementById('popUp').click();
        }
    }

    // playerWrap.addEventListener("click",function(){
    //     // let playerState=player.getPlayerState();
    //     // if(playerState==YT.PlayerState.ENDED){
    //     //     player.seekTo(0);
    //     // }else if(playerState==YT.PlayerState.PAUSED){
    //     //     player.playVideo();
    //     // }
    //     // 上面多行改为下面多行
    //     const videoElement = document.getElementById('player');  // 获取视频元素
    //     let playerState = videoElement.paused ? 2 : 1;  // 2表示暂停，1表示播放中

    //     if (videoElement.ended) {  // 如果视频已经播放结束
    //         videoElement.currentTime = 0;  // 将视频倒回到开头
    //         videoElement.play();  // 开始重新播放
    //     } else if (playerState === 2) {  // 如果视频是暂停状态
    //         videoElement.play();  // 开始播放
    //     // } else {  // 否则暂停视频
    //     //     videoElement.pause();  // 暂停播放
    //     }
    // });

    function record(){
        // var percentComplete = player.getCurrentTime()/player.getDuration();
        // 上面一行改为下面两行
        const videoElement = document.getElementById('player');
        var percentComplete = videoElement.currentTime / videoElement.duration;
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/track');
        xhr.setRequestHeader("Content-Type", "application/json");
        // var state = player.getPlayerState();
        // var status = "playing";
        // if (state == 1) {
        //     status = "playing";
        //   } else if (state == 2){
        //     status = "paused";
        //   } else {
        //     status = "else";
        // }
        // 上面多行改为下面两行（少了else状态）
        var state = videoElement.paused ? 2 : 1; // 1: playing, 2: paused
        var status = state === 1 ? "playing" : "paused";
        var pay_load = {"pct": percentComplete, "id": '{{video_id}}', "status" : status, "time": Date.now()};
        xhr.send(JSON.stringify(pay_load));
        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4) {
            console.log(xhr.status);
            console.log(xhr.responseText);
          }};
    }

    function calPct(){
        // document.getElementById("pct_watched").value = player.getCurrentTime()/player.getDuration();
        // 上一行修改为后两行
        const videoElement = document.getElementById('player');
        document.getElementById("pct_watched").value = videoElement.currentTime / videoElement.duration;
    }

    function pop(){
        document.getElementById("pct_watched").setAttribute("name","next");
        const button = document.getElementById("popUp");
        button.disabled = true;
        // player.stopVideo();
        // 上一行修改为后两行
        const videoElement = document.getElementById('player');
        videoElement.pause(); // 停止当前视频
        //document.getElementById("popupForm").style.display = "block";
        document.getElementById("loader").removeAttribute("hidden");
        document.getElementById("com_con").style.display = "none";
        var pay_load;
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/ready');
        xhr.setRequestHeader("Content-Type", "application/json");
        pay_load = {"id": '{{video_id}}', "status" : "next", "time": Date.now()};
        xhr.send(JSON.stringify(pay_load));
        xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            console.log(xhr.status);
            console.log(xhr.responseText);
            document.getElementById('nextButton').click();
          }
          };
    }

    function prev(){
        button = document.getElementById("prevBtn");
        button.disabled = true;
        document.getElementById("loader").removeAttribute("hidden");
        document.getElementById("pct_watched").setAttribute("name","prev");
        var pay_load;
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/ready');
        xhr.setRequestHeader("Content-Type", "application/json");
        pay_load = {"id": '{{video_id}}', "status" : "prev", "time": Date.now()};
        xhr.send(JSON.stringify(pay_load));
        xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            console.log(xhr.status);
            console.log(xhr.responseText);
            if (xhr.responseText == 'none'){
                document.getElementById("loader").hidden = true;
                alert("No previous video available! This is the first video of this round!");
            }
            else{
                    // player.stopVideo();
                    // 上一行修改为后两行
                    const videoElement = document.getElementById('player');
                    videoElement.pause(); // 停止当前视频
                    document.getElementById("com_con").style.display = "none";
                    document.getElementById('prevButton').click();
                }
          }
          };
    }

</script>
<script>
    function sendLike(){
        var pay_load;
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/feedback');
        xhr.setRequestHeader("Content-Type", "application/json");
        element = document.getElementById('like_btn');
        style = getComputedStyle(element);
        pay_load = {"type": 'like', "id": '{{video_id}}', "status" : style.color};
        xhr.send(JSON.stringify(pay_load));
        xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            var jsonResponse = JSON.parse(xhr.responseText);
            document.getElementById("like_btn").style.color = jsonResponse['code'];
            document.getElementById("num_like").innerHTML = jsonResponse['num_code'];
            console.log(xhr.status);
            console.log(xhr.responseText);
          }
        };
    }

    function sendDis(){
        var pay_load;
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/feedback');
        xhr.setRequestHeader("Content-Type", "application/json");
        element = document.getElementById('dislike_btn');
        style = getComputedStyle(element);
        pay_load = {"type": 'dislike', "id": '{{video_id}}', "status" : style.color};
        xhr.send(JSON.stringify(pay_load));
        xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            var jsonResponse = JSON.parse(xhr.responseText);
            document.getElementById("dislike_btn").style.color = jsonResponse['code'];
            document.getElementById("num_dislike").innerHTML = jsonResponse['num_code'];
            console.log(xhr.status);
            console.log(xhr.responseText);
          }};
    }

    function sendStar(){
        var pay_load;
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/feedback');
        xhr.setRequestHeader("Content-Type", "application/json");
        element = document.getElementById('star_btn');
        style = getComputedStyle(element);
        pay_load = {"type": 'save', "id": '{{video_id}}', "status" : style.color};
        xhr.send(JSON.stringify(pay_load));
        xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            var jsonResponse = JSON.parse(xhr.responseText);
            document.getElementById("star_btn").style.color = jsonResponse['code'];
            document.getElementById("num_saved").innerHTML = jsonResponse['num_code'];
            console.log(xhr.status);
            console.log(xhr.responseText);
          }};
    }

    function sendCom(){
        var pay_load;
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/feedback');
        xhr.setRequestHeader("Content-Type", "application/json");
        var comment = document.getElementById("comment").value
        pay_load = {"type": 'comments', "id": '{{video_id}}', "comment" : comment};
        xhr.send(JSON.stringify(pay_load));
        xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            document.getElementById("comment").value = "";
            resp = JSON.parse(xhr.response);
            document.getElementById("num_comments").innerHTML = resp.len_com;
            const user = resp.username + ": "
            var list = document.getElementById('notes');
            var entry = document.createElement('li');
            entry.classList.add("list-group-item");
            var username = document.createElement('span');
            var com = document.createElement('span');
            username.classList.add("com_username");
            username.appendChild(document.createTextNode(user));
            com.classList.add("com_com");
            com.appendChild(document.createTextNode(resp.comment));
            entry.appendChild(username)
            entry.appendChild(com)
            list.appendChild(entry);
            console.log(xhr.status);
            console.log(xhr.responseText);
          }};
    }
</script>


{% endblock%}